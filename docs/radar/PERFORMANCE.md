# 描画パフォーマンスガイド

## 重要な制限事項

**Canvas描画は無効化されています**

当初、gridSize=1のような小さいグリッドサイズでCanvas描画を使用してパフォーマンスを向上させる実装を試みましたが、以下の根本的な問題により無効化されました：

### Canvas + ImageOverlay の問題点

1. **地図投影の非線形性:** Leafletが使用するWeb Mercator投影では、緯度によって距離の歪みが大きく異なります
2. **平面描画の限界:** Canvasは平面座標系で描画し、ImageOverlayは単純に画像を矩形boundsに引き伸ばすだけです
3. **結果:** ズームアウトした状態では、位置によって大きなずれが発生し、正確な描画ができません

したがって、現在の実装では**SVG方式のみ**を使用しています。

## 描画方式

このアプリケーションはSVG方式のみを使用します：

### SVG方式

**仕組み:**
- Leafletの `L.rectangle` を使用してSVG要素を作成
- 連続する同じ色のグリッドを1つの矩形にまとめる（Run-Length Encoding）
- DOM要素として地図に追加

**利点:**
- ベクター形式なので拡大・縮小しても綺麗
- 地図の移動やズームに自動追従
- 矩形が少ない場合は高速

**欠点:**
- グリッドサイズが小さくなるとDOM要素が膨大になる
- 数千〜数万の矩形を作成するとメモリ使用量とレンダリング時間が急増
- ブラウザの描画エンジンに負荷がかかる

## パフォーマンス特性

### グリッドサイズ別の特性

| Grid Size | DOM要素数（概算） | 描画速度 | 精度 |
|-----------|----------------|---------|-----|
| 16px      | ~400           | 非常に高速 | 粗い |
| 8px       | ~1,500         | 高速 | 中程度 |
| 4px       | ~6,000         | やや遅い | 良好 |
| 2px       | ~24,000        | 遅い | 高精度 |
| 1px       | ~96,000        | 非常に遅い | 最高精度（非推奨） |

※画面サイズ 900x600 の場合

### 推奨設定

**gridSize=1は推奨しません**。パフォーマンスの問題により、実用的ではありません。

**推奨:** `gridSizes: [16, 8, 4, 2]`
- 初期表示が高速（16px）
- 段階的に精度向上（8px, 4px）
- 最終的に実用的な精度（2px）

### 段階的描画のメリット

```javascript
gridSizes: [16, 8, 4, 2]  // 段階的に細かく
```

この組み合わせにより：
- 初期表示が高速（16px）
- ユーザーが結果をすぐに確認可能
- 段階的に精度が向上
- 最終的に2pxで十分な精度

## 使用方法

### 基本設定

```javascript
// config.js
drawing: {
  gridSizes: [8, 2, 1],      // 段階的描画
  canvasThreshold: 2,        // 2px以下でCanvas使用
  progressiveDelay: 500,     // 次の段階への遅延
}
```

### カスタマイズ例

**例1: 標準（推奨）**
```javascript
gridSizes: [16, 8, 4, 2]
canvasThreshold: 0  // 使用しない
```

**例2: 高速優先**
```javascript
gridSizes: [16, 8]
canvasThreshold: 0
```

**例3: 精度優先（遅い）**
```javascript
gridSizes: [16, 8, 4, 2, 1]
canvasThreshold: 0
```
注意: gridSize=1は非常に遅いため、推奨しません。

## トラブルシューティング

### 問題: 描画が遅い

**原因:** gridSizesが細かすぎる、または1pxを含む

**解決策:**
```javascript
gridSizes: [16, 8, 4, 2]  // 1pxを削除
```

### 問題: 精度が足りない

**現状の制限:** gridSize=2が実用的な最小値です

**対処法:**
- より高いズームレベルで表示する
- gridSize=1を試すこともできますが、非常に遅くなります

## まとめ

- **Canvas描画は無効:** Web Mercator投影の非線形性により、正確な描画ができないため
- **SVG方式のみ使用:** 地図座標に正しく追従し、正確な描画が可能
- **推奨設定:** `gridSizes: [16, 8, 4, 2]`, `canvasThreshold: 0`
- **gridSize=1は非推奨:** パフォーマンスの問題により実用的ではない
- **段階的描画:** 粗い段階から細かい段階へ、ユーザー体験を最適化
